<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualisation 3D</title>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      padding: 10px;
      background-color: #f0f0f0;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      z-index: 1;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 250px;
      width: calc(100% - 250px);
      height: calc(100vh - 100px);
      display: block;
    }
    #legend {
      position: absolute;
      bottom: 0;
      left: 250px;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      width: calc(100% - 250px);
    }
  </style>
</head>
<body>
  <div id="sidebar">
Représentation 3D
<hr>
Jean-Herman Guay
<hr>
En rouge, l'axe X, le plus important: il oppose souverainistes et fédéralistes, selon le clivage classique.
<hr>
En vert, l'axe  y, le deuxième: il oppose la gauche et la  droite. 
<hr>
En bleu, l'axe Z, l'opposition est à définir.
<hr>

    <div id="variables"></div>
  </div>
  <canvas id="canvas"></canvas>
  <div id="legend"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
  <script src="data.js"></script>

  <script>
    let scene, camera, renderer, points = [];
    let data, variables, currentVariable;
    let axesHelper;

    function init() {
      // Initialisation de la scène
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      // Ajouter les axes
      axesHelper = new THREE.AxesHelper(10);
      scene.add(axesHelper);

      // Camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth * 0.8 / window.innerHeight, 0.1, 1000);
      camera.position.z = 2;

      // Lumière ambiante
      const ambientLight = new THREE.AmbientLight(0xffffff, 1);
      scene.add(ambientLight);

      // Rendu
      renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('canvas'),
        antialias: true
      });
      renderer.setSize(window.innerWidth * 0.8, window.innerHeight);

      // Contrôles
      const controls = new THREE.OrbitControls(camera, renderer.domElement);

      data = parseCSV(getCsvContent());
      variables = Object.keys(data[0]).filter(key => key !== 'dim1' && key !== 'dim2' && key !== 'dim3');
      createVariablesList();
      createPoints(data);
      animate();
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines.shift().split(',');
      const data = [];

      lines.forEach(line => {
        const values = line.split(',');
        const point = {};

        headers.forEach((header, index) => {
          if (header === 'dim1' || header === 'dim2' || header === 'dim3') {
            point[header] = parseFloat(values[index]);
          } else {
            point[header] = values[index];
          }
        });

        data.push(point);
      });

      return data;
    }

    function createVariablesList() {
      const variablesList = document.getElementById('variables');
      variables.forEach(variable => {
        const checkbox = document.createElement('input');
        checkbox.type = 'radio';
        checkbox.name = 'variable';
        checkbox.id = variable;
        checkbox.addEventListener('change', () => {
          currentVariable = variable;
          updatePoints();
        });

        const label = document.createElement('label');
        label.htmlFor = variable;
        label.textContent = variable;

        const div = document.createElement('div');
        div.appendChild(checkbox);
        div.appendChild(label);

        variablesList.appendChild(div);
      });
    }

    function createPoints(data) {
      const geometry = new THREE.BufferGeometry();
      const positions = [];

      data.forEach(point => {
        positions.push(point.dim1, point.dim2, point.dim3);
      });

      geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

      const material = new THREE.PointsMaterial({ size: 0.02, color: 0x0000ff });
      const pointCloud = new THREE.Points(geometry, material);
      scene.add(pointCloud);
    }

    function updatePoints() {
      scene.clear();
      scene.add(axesHelper);

      const geometry = new THREE.BufferGeometry();
      const positions = [];
      const colors = [];

      const values = [...new Set(data.map(p => p[currentVariable]))];

      data.forEach(point => {
        positions.push(point.dim1, point.dim2, point.dim3);
        const index = values.indexOf(point[currentVariable]);
        const hue = index / values.length;
        const color = new THREE.Color().setHSL(hue, 1, 0.5).getHex();
        colors.push((color >> 16) / 255, ((color >> 8) & 0xff) / 255, (color & 0xff) / 255);
      });

      geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

      const material = new THREE.PointsMaterial({ size: 0.02, vertexColors: true });
      const pointCloud = new THREE.Points(geometry, material);
      scene.add(pointCloud);

      const ambientLight = new THREE.AmbientLight(0xffffff, 1);
      scene.add(ambientLight);

      updateLegend(values);
    }

    function updateLegend(values) {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';

      values.forEach((value, index) => {
        const hue = index / values.length;
        const color = new THREE.Color().setHSL(hue, 1, 0.5).getHex();
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.marginBottom = '5px';

        const colorDiv = document.createElement('div');
        colorDiv.style.width = '20px';
        colorDiv.style.height = '20px';
        colorDiv.style.background = `#${color.toString(16).padStart(6, '0')}`;
        colorDiv.style.marginRight = '10px';

        const textSpan = document.createElement('span');
        textSpan.textContent = value;

        div.appendChild(colorDiv);
        div.appendChild(textSpan);
        legend.appendChild(div);
      });
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    // Initialisation
    init();
  </script>
</body>
</html>