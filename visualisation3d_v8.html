<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualisation 3D</title>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      height: 100vh;
      padding: 10px;
      background-color: #ADD8E6;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      z-index: 1;
    }

    #sidebar input[type="radio"] {
  width: 25px;
  height: 25px;
  margin: 10px;
  }
    #canvas {
      position: absolute;
      top: 0;
      left: 250px;
      width: calc(100% - 250px);
      height: calc(100vh - 100px);
      display: block;
    }
    #legend {
      position: absolute;
      bottom: 0;
      left: 250px;
      background-color: #f0f0f0;
      padding: 10px 20px;
      border: 1px solid #ccc;
      width: calc(100% - 250px - 40px);
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Représentation 3D</h1>
    <hr>
    Bouger le nuage pour le voir en 3 dimensions!
    <hr>
    Jean-Herman Guay
    <hr>
    En rouge, l'axe X, le plus important: il oppose souverainistes et fédéralistes, selon le clivage classique.
    <hr>
    En vert, l'axe  y, le deuxième: il oppose la gauche et la  droite. 
    <hr>
    En bleu, l'axe Z, l'opposition est entre les générations, plus jeunes et plus vieux.
    <hr>
    <a href='https://jhguay.github.io/DonneesEnMain/GuayRapportComplementaire.pdf' target="_blank">Document complémentaire pour l'interprétation </a>
    <hr>
    <div id="variables"></div>
  </div>
  <canvas id="canvas"></canvas>
  <div id="legend"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
  <script src="data.js"></script>

  <script>
    let scene, camera, renderer;
    let data, variables, currentVariable;
    let axesHelper;
    let visibleCategories = {};
    let colors = [
      0xFF0000, // Rouge
      0x0000FF, // Bleu
      0x00FF00, // Vert
      0xFFFF00, // Jaune
      0xFF00FF, // Magenta
      0x00FFFF, // Cyan
      0x800000, // Rouge foncé
      0x008000, // Vert foncé
      0x000080, // Bleu foncé
      0x808000 // Brun
    ];

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      axesHelper = new THREE.AxesHelper(10);
      scene.add(axesHelper);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth * 0.8 / window.innerHeight, 0.1, 1000);
      camera.position.z = 2;

      const ambientLight = new THREE.AmbientLight(0xffffff, 1);
      scene.add(ambientLight);

      renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('canvas'),
        antialias: true
      });
      renderer.setSize(window.innerWidth * 0.8, window.innerHeight);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);

      data = parseCSV(getCsvContent());
      variables = Object.keys(data[0]).filter(key => key !== 'dim1' && key !== 'dim2' && key !== 'dim3');
      createVariablesList();
      createPoints(data);
      animate();
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines.shift().split(',');
      const data = [];

      lines.forEach(line => {
        const values = line.split(',');
        const point = {};

        headers.forEach((header, index) => {
          if (header === 'dim1' || header === 'dim2' || header === 'dim3') {
            point[header] = parseFloat(values[index]);
          } else {
            point[header] = values[index];
          }
        });

        data.push(point);
      });

      return data;
    }

    function createVariablesList() {
      const variablesList = document.getElementById('variables');
      variables.forEach(variable => {
        const checkbox = document.createElement('input');
        checkbox.type = 'radio';
        checkbox.name = 'variable';
        checkbox.id = variable;
        checkbox.addEventListener('change', () => {
          currentVariable = variable;
          visibleCategories = {};
          updatePoints();
        });

        const label = document.createElement('label');
        label.htmlFor = variable;
        label.textContent = variable;

        const div = document.createElement('div');
        div.appendChild(checkbox);
        div.appendChild(label);

        variablesList.appendChild(div);
      });
    }

    function createPoints(data) {
      data.forEach(point => {
        const geometry = new THREE.SphereGeometry(0.015, 16, 16);
        const material = new THREE.MeshBasicMaterial({ color: 0x0000ff });
        const sphere = new THREE.Mesh(geometry, material);
        sphere.position.set(point.dim1, point.dim2, point.dim3);
        scene.add(sphere);
      });
    }

    function updatePoints() {
      scene.clear();
      scene.add(axesHelper);

      const values = [...new Set(data.map(p => p[currentVariable]))];

      data.forEach(point => {
        if (!(point[currentVariable] in visibleCategories) || visibleCategories[point[currentVariable]]) {
          const geometry = new THREE.SphereGeometry(0.015, 16, 16);
          const index = values.indexOf(point[currentVariable]);
          const color = new THREE.Color(colors[index % colors.length]);
          const material = new THREE.MeshBasicMaterial({ color: color });
          const sphere = new THREE.Mesh(geometry, material);
          sphere.position.set(point.dim1, point.dim2, point.dim3);
          scene.add(sphere);
        }
      });

      const ambientLight = new THREE.AmbientLight(0xffffff, 1);
      scene.add(ambientLight);

      updateLegend(values);
    }

    function updateLegend(values) {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';

      const counts = {};
      data.forEach(point => {
        const value = point[currentVariable];
        if (counts[value]) {
          counts[value]++;
        } else {
          counts[value] = 1;
        }
      });

      values.forEach((value, index) => {
        const color = new THREE.Color(colors[index % colors.length]);
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.marginBottom = '5px';

        const colorDiv = document.createElement('div');
        colorDiv.style.width = '20px';
        colorDiv.style.height = '20px';
        colorDiv.style.borderRadius = '50%';
        colorDiv.style.background = `#${color.getHexString()}`;
        colorDiv.style.marginRight = '10px';

        const textSpan = document.createElement('span');
        if (value === '') {
          textSpan.textContent = `Ne sais pas (${counts[value]})`;
        } else {
          textSpan.textContent = `${value} (${counts[value]})`;
        }

        div.appendChild(colorDiv);
        div.appendChild(textSpan);
        legend.appendChild(div);

        div.addEventListener('click', () => {
          if (!(value in visibleCategories)) {
            visibleCategories[value] = true;
          }
          visibleCategories[value] = !visibleCategories[value];
          updatePoints();
        });

        if (!(value in visibleCategories)) {
          visibleCategories[value] = true;
        }
      });
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    init();
  </script>
</body>
</html>
